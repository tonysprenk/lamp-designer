<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organic Lamp Designer</title>

  <style>
    :root{
      --stage-bg: #0e1116;
      --panel-bg: #f6f8fb;
      --panel-border: #d9e0ea;
      --text: #1c2636;
      --muted: #5b6b82;
      --chip: #eef3ff;
      --slider-track:#d7dfeb;
      --slider-thumb:#2b6ef3;
    }

    *{box-sizing:border-box}
    html, body { height:100%; margin:0; font-family:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; color:var(--text); background:var(--stage-bg); }
    #app { display:grid; grid-template-columns:360px 1fr; height:100%; }

    aside#sidebar {
      background:var(--panel-bg);
      border-right:1px solid var(--panel-border);
      overflow:auto; padding:16px;
      display:flex; flex-direction:column;
    }

    h1 { font-size:18px; margin:0 0 10px; color:var(--text); display:flex; align-items:baseline; gap:8px; }
    #version { font-size:12px; color:var(--muted); background:#eef3ff; border-radius:999px; padding:2px 8px; }
    .row { margin:12px 0 18px; }
    label { display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-bottom:6px; }
    select, input[type=range] { width:100%; }
    select {
      background:white; border:1px solid var(--panel-border); border-radius:10px; padding:10px 12px; color:var(--text);
      outline:none;
    }
    input[type=range]{ -webkit-appearance:none; height:32px; background:transparent; padding:6px 0; }
    input[type=range]::-webkit-slider-runnable-track{ height:6px; background:var(--slider-track); border-radius:999px; }
    input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:22px; height:22px; border-radius:50%; background:var(--slider-thumb); margin-top:-8px; box-shadow:0 1px 3px rgba(0,0,0,.2); }

    .note { font-size:11px; color:var(--muted); margin-top:10px; }

    /* Download button */
    .download-btn{
      margin-top:auto;
      background:#2b6ef3;
      color:white;
      border:none;
      padding:12px;
      border-radius:10px;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      transition:background .2s ease;
      text-align:center;
    }
    .download-btn:hover{ background:#1958d9; }

    #canvas { display:block; width:100%; height:100%; background:var(--stage-bg); }

    /* ---------- Mobile bottom sheet ---------- */
    @media (max-width: 900px){
      #app{
        display:grid;
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
        height: 100svh;
      }

      aside#sidebar{
        grid-row: 2 / 3;
        width: 100%;
        max-height: 48svh;
        height: min(48svh, 420px);
        border-right:none;
        border-top:1px solid var(--panel-border);
        background:var(--panel-bg);
        padding:0;
      }

      aside#sidebar.collapsed{
        height:56px;
        max-height:56px;
        overflow:hidden;
      }

      .sheet-handle{
        position:sticky; top:0;
        background:var(--panel-bg);
        padding:8px 12px;
        z-index:1;
        border-bottom:1px solid var(--panel-border);
        display:flex; align-items:center; justify-content:space-between; gap:8px;
      }
      .dragbar{ width:48px; height:5px; border-radius:999px; background:#cdd7e7; }
      .sheet-content{
        padding:12px 16px 14px;
        overflow:auto;
        -webkit-overflow-scrolling:touch;
        max-height:calc(100% - 42px);
        display:flex; flex-direction:column;
      }
      .toggle{
        border:1px solid var(--panel-border); background:white; color:var(--text);
        border-radius:10px; padding:6px 10px; font-size:13px;
      }
      .desktop-header{display:none;}
    }

    .desktop-header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px;}
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "@app/": "./src/"
    }
  }
  </script>

  <script> window.APP_VERSION = "0.9.3"; </script>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <div class="desktop-header">
      <h1>Organic Lamp Designer <span id="version"></span></h1>
    </div>
    <div class="sheet-handle">
      <div class="dragbar"></div>
      <button id="togglePanel" class="toggle">Collapse</button>
    </div>

    <div class="sheet-content">
      <div class="row"><label><span>Height (mm)</span><span id="val_height"></span></label><input id="height" type="range" min="120" max="250" value="230"></div>
      <div class="row"><label><span>Base Radius (mm)</span><span id="val_rbase"></span></label><input id="rbase" type="range" min="40" max="64" value="64"></div>
      <div class="row"><label><span>Top Scale (0.4–1.2)</span><span id="val_topscale"></span></label><input id="topscale" type="range" min="0.4" max="1.2" step="0.01" value="0.70"></div>
      <div class="row"><label><span>Waves</span><span id="val_waves"></span></label><input id="waves" type="range" min="6" max="40" value="18"></div>
      <div class="row"><label><span>Amplitude</span><span id="val_amp"></span></label><input id="amp" type="range" min="0" max="0.35" step="0.01" value="0.22"></div>
      <div class="row"><label><span>Twist (°)</span><span id="val_twist"></span></label><input id="twist" type="range" min="0" max="900" step="10" value="420"></div>

      <div class="row"><label><span>Ripple Direction</span></label>
        <select id="ripdir">
          <option value="vertical" selected>Vertical folds (around)</option>
          <option value="horizontal">Horizontal rings (stacked)</option>
        </select>
      </div>

      <div class="row"><label><span>Mounting</span></label>
        <select id="mount">
          <option value="hanging" selected>Hanging (top cap + cable + E27)</option>
        </select>
      </div>

      <div class="row"><label><span>Finish</span></label>
        <select id="finish">
          <option value="opaque_white" selected>Opaque white (gloss)</option>
          <option value="translucent_white">Translucent white (gloss)</option>
          <option value="bronze">Bronze (polished)</option>
          <option value="silver">Silver (polished)</option>
          <option value="gold">Gold (polished)</option>
        </select>
      </div>

      <div class="row"><label><span>Preview Quality</span></label>
        <select id="res">
          <option value="low">Low (fast)</option>
          <option value="med" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>

      <div class="note">Hanging lamp preview. Vase-mode preview; internal ~0.7 mm wall for manufacturing. E27 hole fixed.</div>

      <button id="downloadSTL" class="download-btn">⬇ Download STL</button>
    </div>
  </aside>

  <canvas id="canvas"></canvas>
</div>

<script type="module">
  import "@app/main.js";
  import { forceResize } from "@app/main.js";

  const aside = document.getElementById('sidebar');
  const btn   = document.getElementById('togglePanel');
  const mq    = window.matchMedia('(max-width: 900px)');

  function applyInitialState(){
    if (mq.matches){
      aside.classList.remove('collapsed');
      btn.textContent = 'Collapse';
    } else {
      aside.classList.remove('collapsed');
      btn.textContent = 'Controls';
    }
    forceResize();
  }

  function togglePanel(){
    if (!mq.matches) return;
    const collapsed = aside.classList.toggle('collapsed');
    btn.textContent = collapsed ? 'Expand' : 'Collapse';
    forceResize();
  }

  btn.addEventListener('click', togglePanel);
  mq.addEventListener?.('change', applyInitialState);
  window.addEventListener('orientationchange', applyInitialState, { passive:true });
  applyInitialState();
</script>
</body>
</html>
