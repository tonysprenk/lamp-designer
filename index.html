<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organic Lamp Designer</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#0b0e12; color:#e8eef7; }
    #app { display: grid; grid-template-columns: 320px 1fr; height: 100%; }
    aside { padding: 16px; border-right: 1px solid #1b2230; overflow:auto; background:#101620; }
    #canvas { display:block; width:100%; height:100%; }
    h1 { font-size: 18px; margin: 0 0 12px; color:#cfe0ff; }
    .row { margin: 10px 0; }
    label { display:flex; justify-content:space-between; font-size:12px; color:#9bb0cc; margin-bottom:6px; }
    input[type=range] { width: 100%; }
    button { margin-top:20px; width:100%; padding:10px; border-radius:8px; border:1px solid #31507a; background:#18253a; color:#e8eef7; cursor:pointer; }
  </style>

  <!-- Import map so Safari/GitHub Pages can resolve bare imports -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
<div id="app">
  <aside>
    <h1>Organic Lamp Designer</h1>
    <div class="row"><label><span>Height</span><span id="val_height"></span></label><input id="height" type="range" min="120" max="400" value="230"></div>
    <div class="row"><label><span>Base Radius</span><span id="val_rbase"></span></label><input id="rbase" type="range" min="50" max="140" value="85"></div>
    <div class="row"><label><span>Waves</span><span id="val_waves"></span></label><input id="waves" type="range" min="6" max="36" value="18"></div>
    <div class="row"><label><span>Amplitude</span><span id="val_amp"></span></label><input id="amp" type="range" min="0" max="0.35" step="0.01" value="0.22"></div>
    <div class="row"><label><span>Twist</span><span id="val_twist"></span></label><input id="twist" type="range" min="0" max="900" step="10" value="420"></div>
    <div class="row"><label><span>Wall Thick</span><span id="val_thick"></span></label><input id="thick" type="range" min="1" max="4" step="0.1" value="2.0"></div>
    <button id="download">Download STL</button>
  </aside>
  <canvas id="canvas"></canvas>
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { STLExporter } from "three/addons/exporters/STLExporter.js";

const canvas = document.getElementById('canvas');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth-320, window.innerHeight);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0e12);

// camera
const camera = new THREE.PerspectiveCamera(45, (window.innerWidth-320)/window.innerHeight, 0.1, 2000);
camera.position.set(0, -400, 200);
const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0,0,115);
controls.update();

// lights
scene.add(new THREE.HemisphereLight(0xffffff, 0x223344, 0.8));
const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(200,200,300); scene.add(dir);

// grid
const grid = new THREE.GridHelper(600, 30, 0x294059, 0x1a283b); grid.position.z=-0.1; scene.add(grid);

let group;
const material = new THREE.MeshStandardMaterial({color:0xdde7ff, roughness:0.55, metalness:0.0});

// params
const params = {height:230, rbase:85, waves:18, amp:0.22, twist:420, thick:2.0};

function buildGeometry() {
  const radialSeg=120, heightSeg=160;
  const verts=[], idx=[];
  const H=params.height, R0=params.rbase, waves=params.waves, amp=params.amp, twist=params.twist*Math.PI/180;
  for (let j=0;j<=heightSeg;j++){
    const v=j/heightSeg, z=H*v, phase=twist*v;
    for (let i=0;i<=radialSeg;i++){
      const u=i/radialSeg, ang=u*2*Math.PI;
      const r=R0*(1+amp*Math.sin(waves*ang+phase));
      verts.push(r*Math.cos(ang), r*Math.sin(ang), z);
    }
  }
  for (let j=0;j<heightSeg;j++){
    for (let i=0;i<radialSeg;i++){
      const a=j*(radialSeg+1)+i;
      const b=a+1, c=a+(radialSeg+1), d=c+1;
      idx.push(a,c,b, b,c,d);
    }
  }
  const geo=new THREE.BufferGeometry();
  geo.setAttribute('position', new THREE.Float32BufferAttribute(verts,3));
  geo.setIndex(idx);
  geo.computeVertexNormals();
  return geo;
}

function rebuild(){
  if(group){ scene.remove(group); group.traverse(o=>{if(o.geometry) o.geometry.dispose();}); }
  group=new THREE.Group();
  const outer=new THREE.Mesh(buildGeometry(), material);
  group.add(outer);
  scene.add(group);
}

function bind(id,key){
  const el=document.getElementById(id), lab=document.getElementById("val_"+id);
  el.oninput=()=>{params[key]=parseFloat(el.value); lab.textContent=el.value; rebuild();};
  lab.textContent=el.value; params[key]=parseFloat(el.value);
}
['height','rbase','waves','amp','twist','thick'].forEach(id=>{ bind(id,id); });
rebuild();

// STL download
document.getElementById('download').onclick=()=>{
  const exporter=new STLExporter();
  const stl=exporter.parse(group);
  const blob=new Blob([stl],{type:'application/sla'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='lamp.stl'; a.click();
};

window.addEventListener('resize',()=>{
  renderer.setSize(window.innerWidth-320, window.innerHeight);
  camera.aspect=(window.innerWidth-320)/window.innerHeight;
  camera.updateProjectionMatrix();
});

function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
animate();
</script>
</body>
</html>
