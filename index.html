<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organic Lamp Designer</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#0b0e12; color:#e8eef7; }
    #app { display: grid; grid-template-columns: 340px 1fr; height: 100%; }
    aside { padding: 16px; border-right: 1px solid #1b2230; overflow:auto; background:#101620; }
    #canvas { display:block; width:100%; height:100%; }
    h1 { font-size: 18px; margin: 0 0 12px; color:#cfe0ff; }
    .row { margin: 10px 0 16px; }
    label { display:flex; justify-content:space-between; font-size:12px; color:#9bb0cc; margin-bottom:6px; }
    input[type=range], select { width: 100%; }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    button { margin-top:10px; width:100%; padding:10px; border-radius:10px; border:1px solid #31507a; background:#18253a; color:#e8eef7; cursor:pointer; }
    button:hover { filter: brightness(1.1); }
    .note { font-size:11px; color:#8aa4c8; margin-top:8px; }
  </style>

  <!-- Import map for Safari/GitHub Pages -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
<div id="app">
  <aside>
    <h1>Organic Lamp Designer</h1>

    <div class="row"><label><span>Height (mm)</span><span id="val_height"></span></label><input id="height" type="range" min="120" max="450" value="230"></div>
    <div class="row"><label><span>Base Radius (mm)</span><span id="val_rbase"></span></label><input id="rbase" type="range" min="50" max="160" value="90"></div>
    <div class="row"><label><span>Top Scale (0.4–1.2)</span><span id="val_topscale"></span></label><input id="topscale" type="range" min="0.4" max="1.2" step="0.01" value="0.70"></div>

    <div class="two">
      <div class="row"><label><span>Waves</span><span id="val_waves"></span></label><input id="waves" type="range" min="6" max="40" value="18"></div>
      <div class="row"><label><span>Twist (°)</span><span id="val_twist"></span></label><input id="twist" type="range" min="0" max="900" step="10" value="420"></div>
    </div>
    <div class="two">
      <div class="row"><label><span>Amplitude</span><span id="val_amp"></span></label><input id="amp" type="range" min="0" max="0.35" step="0.01" value="0.22"></div>
      <div class="row"><label><span>Wall (mm)</span><span id="val_thick"></span></label><input id="thick" type="range" min="0.8" max="5" step="0.1" value="2.0"></div>
    </div>

    <div class="two">
      <div class="row"><label><span>Top Ø (mm)</span><span id="val_top"></span></label><input id="topHole" type="range" min="10" max="80" step="1" value="36"></div>
      <div class="row"><label><span>Bottom Ø (mm)</span><span id="val_bottom"></span></label><input id="bottomHole" type="range" min="60" max="260" step="1" value="140"></div>
    </div>

    <div class="row"><label><span>Ripple Direction</span></label>
      <select id="ripdir">
        <option value="vertical" selected>Vertical folds (around)</option>
        <option value="horizontal">Horizontal rings (stacked)</option>
      </select>
    </div>

    <div class="row"><label><span>Finish</span></label>
      <select id="finish">
        <option value="opaque_white" selected>Opaque white</option>
        <option value="translucent_white">Translucent white</option>
        <option value="bronze">Bronze</option>
        <option value="silver">Silver</option>
        <option value="gold">Gold</option>
      </select>
    </div>

    <div class="row"><label><span>Quality</span></label>
      <select id="res">
        <option value="low">Low (fast)</option>
        <option value="med" selected>Medium</option>
        <option value="high">High</option>
      </select>
    </div>

    <button id="download">Download STL</button>
    <div class="note">Preview is now solid (double-sided) and shows wall thickness by rendering inner & outer shells. Use High quality for export.</div>
  </aside>
  <canvas id="canvas"></canvas>
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { STLExporter } from "three/addons/exporters/STLExporter.js";

const canvas = document.getElementById('canvas');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth-340, window.innerHeight);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0e12);

// camera
const camera = new THREE.PerspectiveCamera(45, (window.innerWidth-340)/window.innerHeight, 0.1, 5000);
camera.position.set(0, -520, 260);
const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0,0,140);
controls.enableDamping = true;
controls.update();

// lights
scene.add(new THREE.HemisphereLight(0xffffff, 0x223344, 0.9));
const dir = new THREE.DirectionalLight(0xffffff, 0.7); dir.position.set(200,220,360); scene.add(dir);

// grid
const grid = new THREE.GridHelper(800, 40, 0x294059, 0x1a283b); grid.position.z=-0.1; scene.add(grid);

let group;
let materialOuter, materialInner;

const params = {
  height:230, rbase:90, topscale:0.70,
  waves:18, amp:0.22, twist:420,
  topHole:36, bottomHole:140,
  ripdir:'vertical', finish:'opaque_white', res:'med',
  wallFixed: 0.7 // vase-mode wall (mm)
};

function makeMaterial() {
  const finish = params.finish;
  if (finish === 'translucent_white') {
    materialOuter = new THREE.MeshPhysicalMaterial({ color:0xffffff, roughness:0.2, metalness:0.0, transmission:0.75, thickness: 4.0, clearcoat:0.05, side:THREE.DoubleSide });
    materialInner = materialOuter;
  } else if (finish === 'bronze') {
    materialOuter = new THREE.MeshStandardMaterial({ color:0x8c6a3f, metalness:0.85, roughness:0.35, side:THREE.DoubleSide });
    materialInner = materialOuter;
  } else if (finish === 'silver') {
    materialOuter = new THREE.MeshStandardMaterial({ color:0xcfd3d8, metalness:0.95, roughness:0.25, side:THREE.DoubleSide });
    materialInner = materialOuter;
  } else if (finish === 'gold') {
    materialOuter = new THREE.MeshStandardMaterial({ color:0xd4af37, metalness:0.9, roughness:0.3, side:THREE.DoubleSide });
    materialInner = materialOuter;
  } else { // opaque_white
    materialOuter = new THREE.MeshStandardMaterial({ color:0xdde7ff, metalness:0.05, roughness:0.55, side:THREE.DoubleSide });
    materialInner = materialOuter;
  }
}

function baseRadius(t, R0, R1) {
  // gentle belly with mid emphasis
  const belly = 1 + 0.18 * (1 - Math.pow(Math.abs(2*t-1), 1.4));
  return THREE.MathUtils.lerp(R0, R1, t) * belly;
}

function buildSurface(offsetR=0, isInner=false) {
  const radialSeg = params.res==='low'? 80 : (params.res==='med'? 160 : 240);
  const heightSeg = params.res==='low'? 110 : (params.res==='med'? 180 : 300);

  const H = params.height;
  const R0 = params.rbase;
  const R1 = R0 * params.topscale;
  const waves = params.waves;
  const amp = Math.max(0, params.amp - (isInner? params.thick/(R0*1.6) : 0));
  const twist = THREE.MathUtils.degToRad(params.twist);

  const verts = new Float32Array((radialSeg+1)*(heightSeg+1)*3);
  let p=0;
  for (let j=0;j<=heightSeg;j++){
    const v = j/heightSeg;
    const z = H * v;
    const phase = twist * v;
    for (let i=0;i<=radialSeg;i++){
      const u = i/radialSeg;
      const ang = u * Math.PI*2;
      const br = baseRadius(v, R0, R1) + (isInner? -params.thick : 0) + offsetR;
      let r;
      if (params.ripdir === 'vertical') {
        r = br * (1 + amp * Math.sin(waves*ang + phase));
      } else {
        r = br * (1 + amp * Math.sin((waves*2*Math.PI)*v + 1.5*ang));
      }
      verts[p++] = r * Math.cos(ang);
      verts[p++] = r * Math.sin(ang);
      verts[p++] = z;
    }
  }
  const geo = new THREE.BufferGeometry();
  geo.setAttribute('position', new THREE.BufferAttribute(verts,3));
  const idx = new Uint32Array(radialSeg*heightSeg*6);
  let k=0;
  for (let j=0;j<heightSeg;j++){
    for (let i=0;i<radialSeg;i++){
      const a = j*(radialSeg+1)+i;
      const b = a+1;
      const c = a+(radialSeg+1);
      const d = c+1;
      if (!isInner) {
        idx[k++]=a; idx[k++]=c; idx[k++]=b; idx[k++]=b; idx[k++]=c; idx[k++]=d;
      } else {
        idx[k++]=a; idx[k++]=b; idx[k++]=c; idx[k++]=b; idx[k++]=d; idx[k++]=c;
      }
    }
  }
  geo.setIndex(new THREE.BufferAttribute(idx,1));
  geo.computeVertexNormals();
  return geo;
}

function rebuild(){
  const set = (id,val)=>{ const el=document.getElementById('val_'+id); if(el) el.textContent = String(val); };
  set('height', params.height);
  set('rbase', params.rbase);
  set('topscale', params.topscale?.toFixed? params.topscale.toFixed(2): params.topscale);
  set('waves', params.waves);
  set('amp', params.amp.toFixed(2));
  set('twist', params.twist);
  set('top', params.topHole);
  set('bottom', params.bottomHole);

  if(group){ scene.remove(group); group.traverse(o=>{ if(o.geometry) o.geometry.dispose(); }); }
  group = new THREE.Group();

  makeMaterial();

  // PREVIEW: single-wall outer only (for vase-mode look)
  const outerGeo = buildSurface(0,false);
  const outerMesh = new THREE.Mesh(outerGeo, materialOuter);
  group.add(outerMesh);

  // Visual openings (not boolean): dim cylinders so you can size holes
  const holeMat = new THREE.MeshStandardMaterial({ color:0x0b0e12, metalness:0.0, roughness:1.0, side:THREE.DoubleSide });
  const tCyl = new THREE.Mesh(new THREE.CylinderGeometry(params.topHole/2, params.topHole/2, params.height*2, 100), holeMat);
  tCyl.rotation.x = Math.PI/2; tCyl.position.z = params.height - 0.01;
  const bCyl = new THREE.Mesh(new THREE.CylinderGeometry(params.bottomHole/2, params.bottomHole/2, params.height*2, 100), holeMat);
  bCyl.rotation.x = Math.PI/2; bCyl.position.z = -params.height;
  group.add(tCyl, bCyl);

  scene.add(group);
}
}

function bindRange(id,key,fmt){
  const el=document.getElementById(id), lab=document.getElementById('val_'+id);
  const update=()=>{ params[key]=parseFloat(el.value); if(lab) lab.textContent = fmt? fmt(el.value): el.value; rebuild(); };
  el.addEventListener('input', update); update();
}

bindRange('height','height');
bindRange('rbase','rbase');
bindRange('topscale','topscale', v=>Number(v).toFixed(2));
bindRange('waves','waves');
bindRange('amp','amp', v=>Number(v).toFixed(2));
bindRange('twist','twist');
bindRange('thick','thick', v=>Number(v).toFixed(1));
bindRange('topHole','topHole');
bindRange('bottomHole','bottomHole');

document.getElementById('ripdir').addEventListener('change', (e)=>{ params.ripdir = e.target.value; rebuild(); });

document.getElementById('finish').addEventListener('change', (e)=>{ params.finish = e.target.value; rebuild(); });

document.getElementById('res').addEventListener('change', (e)=>{ params.res = e.target.value; rebuild(); });

// STL download (exports outer+inner surfaces; slicers interpret correctly as closed shell)
document.getElementById('download').onclick=()=>{
  // For STL: export a proper thin solid by including an inner surface offset by wallFixed
  const exportGroup = new THREE.Group();
  const outer = new THREE.Mesh(buildSurface(0,false), materialOuter);
  const inner = new THREE.Mesh(buildSurface(0,true), materialOuter);
  exportGroup.add(outer); exportGroup.add(inner);
  const exporter = new STLExporter();
  const stl = exporter.parse(exportGroup);
  const blob = new Blob([stl],{type:'application/sla'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='organic_lamp_vasemode_'+params.wallFixed+'mm.stl'; a.click();
};  const stl = exporter.parse(group);
  const blob = new Blob([stl],{type:'application/sla'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='organic_lamp.stl'; a.click();
};

window.addEventListener('resize',()=>{
  renderer.setSize(window.innerWidth-340, window.innerHeight);
  camera.aspect=(window.innerWidth-340)/window.innerHeight;
  camera.updateProjectionMatrix();
});

function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
rebuild();
animate();
</script>
</body>
</html>
