<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organic Lamp Designer — Vase Mode (Bambu X1C Safe)</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#0b0e12; color:#e8eef7; }
    #app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    aside { padding: 16px; border-right: 1px solid #1b2230; overflow:auto; background:#101620; }
    #canvas { display:block; width:100%; height:100%; }
    h1 { font-size: 18px; margin: 0 0 8px; color:#cfe0ff; display:flex; align-items:baseline; gap:8px; }
    #version { font-size:12px; color:#8aa4c8; }
    .row { margin: 10px 0 16px; }
    label { display:flex; justify-content:space-between; font-size:12px; color:#9bb0cc; margin-bottom:6px; }
    input[type=range], select { width: 100%; }
    .note { font-size:11px; color:#8aa4c8; margin-top:10px; }
  </style>

  <!-- Static import map (Safari-friendly) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <!-- Version (bump this each deploy) -->
  <script>
    window.APP_VERSION = "0.6.1";
  </script>
</head>
<body>
<div id="app">
  <aside>
    <h1>Organic Lamp Designer <span id="version"></span></h1>

    <div class="row"><label><span>Height (mm)</span><span id="val_height"></span></label><input id="height" type="range" min="120" max="250" value="230"></div>
    <div class="row"><label><span>Base Radius (mm)</span><span id="val_rbase"></span></label><input id="rbase" type="range" min="40" max="120" value="90"></div>
    <div class="row"><label><span>Top Scale (0.4–1.2)</span><span id="val_topscale"></span></label><input id="topscale" type="range" min="0.4" max="1.2" step="0.01" value="0.70"></div>
    <div class="row"><label><span>Waves</span><span id="val_waves"></span></label><input id="waves" type="range" min="6" max="40" value="18"></div>
    <div class="row"><label><span>Amplitude</span><span id="val_amp"></span></label><input id="amp" type="range" min="0" max="0.35" step="0.01" value="0.22"></div>
    <div class="row"><label><span>Twist (°)</span><span id="val_twist"></span></label><input id="twist" type="range" min="0" max="900" step="10" value="420"></div>

    <div class="row"><label><span>Top Opening Ø (mm)</span><span id="val_top"></span></label><input id="topHole" type="range" min="10" max="80" step="1" value="36"></div>
    <div class="row"><label><span>Bottom Opening Ø (mm)</span><span id="val_bottom"></span></label><input id="bottomHole" type="range" min="60" max="240" step="1" value="140"></div>

    <div class="row"><label><span>Ripple Direction</span></label>
      <select id="ripdir">
        <option value="vertical" selected>Vertical folds (around)</option>
        <option value="horizontal">Horizontal rings (stacked)</option>
      </select>
    </div>

    <div class="row"><label><span>Mounting</span></label>
      <select id="mount">
        <option value="standing" selected>Standing (bottom cap + E27 clamp)</option>
        <option value="hanging">Hanging (top cap + cable + E27 clamp)</option>
      </select>
    </div>

    <div class="row"><label><span>Finish</span></label>
      <select id="finish">
        <option value="opaque_white" selected>Opaque white (gloss)</option>
        <option value="translucent_white">Translucent white (gloss)</option>
        <option value="bronze">Bronze (polished)</option>
        <option value="silver">Silver (polished)</option>
        <option value="gold">Gold (polished)</option>
      </select>
    </div>

    <div class="row"><label><span>Preview Quality</span></label>
      <select id="res">
        <option value="low">Low (fast)</option>
        <option value="med" selected>Medium</option>
        <option value="high">High</option>
      </select>
    </div>

    <div class="note">Max size auto-clamped for <b>Bambu Lab X1C</b> (256×256×256 mm). Preview is single-wall <b>vase mode</b>; manufacturing uses ~0.7 mm wall internally.</div>
  </aside>
  <canvas id="canvas"></canvas>
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { RoomEnvironment } from "three/addons/environments/RoomEnvironment.js";

const canvas = document.getElementById('canvas');
const renderer = new THREE.WebGLRenderer({canvas: canvas, antialias: true});
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth - 360, window.innerHeight);
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0e12);
const pmrem = new THREE.PMREMGenerator(renderer);
scene.environment = pmrem.fromScene(new RoomEnvironment()).texture;

const camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 360) / window.innerHeight, 0.1, 5000);
camera.position.set(420, -420, 240); // oblique view
const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0, 0, 115);
controls.enableDamping = true;
controls.update();

// lights
scene.add(new THREE.HemisphereLight(0xffffff, 0x223344, 0.9));
const dir = new THREE.DirectionalLight(0xffffff, 1.0);
dir.position.set(300, -300, 480);
scene.add(dir);

// grid on XY at z=0 (Z-up ground)
const grid = new THREE.GridHelper(800, 40, 0x294059, 0x1a283b);
grid.rotation.x = Math.PI / 2;
grid.position.z = 0;
scene.add(grid);

let group;
let materialOuter;

const params = {
  height: 230,
  rbase: 90,
  topscale: 0.70,
  waves: 18,
  amp: 0.22,
  twist: 420,
  topHole: 36,
  bottomHole: 140,
  ripdir: "vertical",
  finish: "opaque_white",
  res: "med",
  wallFixed: 0.7,
  mount: "standing"
};

function setVersion() {
  var vEl = document.getElementById('version');
  if (vEl && window.APP_VERSION) vEl.textContent = "v" + window.APP_VERSION;
  if (window.APP_VERSION) console.log("Organic Lamp Designer v" + window.APP_VERSION);
}

function makeMaterial() {
  var glossy = { clearcoat: 1.0, clearcoatRoughness: 0.04, roughness: 0.12, envMapIntensity: 1.3, side: THREE.DoubleSide };
  var opts;
  switch (params.finish) {
    case "translucent_white":
      opts = { color: 0xffffff, transmission: 0.55, thickness: 3.0, metalness: 0.0 };
      break;
    case "bronze":
      opts = { color: 0x8c6a3f, metalness: 1.0, roughness: 0.22 };
      break;
    case "silver":
      opts = { color: 0xcfd3d8, metalness: 1.0, roughness: 0.12 };
      break;
    case "gold":
      opts = { color: 0xd4af37, metalness: 1.0, roughness: 0.18 };
      break;
    case "opaque_white":
    default:
      opts = { color: 0xf5f7fb, metalness: 0.0 };
      break;
  }
  materialOuter = new THREE.MeshPhysicalMaterial(Object.assign({}, glossy, opts));
}

function baseRadius(t, R0, R1) {
  var belly = 1 + 0.18 * (1 - Math.pow(Math.abs(2 * t - 1), 1.4));
  return THREE.MathUtils.lerp(R0, R1, t) * belly;
}

// Inner radius at a given height fraction v and angle ang (radians)
function innerRadiusAt(v, ang) {
  var R0 = params.rbase;
  var R1 = R0 * params.topscale;
  var br = baseRadius(v, R0, R1);
  var twist = THREE.MathUtils.degToRad(params.twist);
  var phase = twist * v;
  var amp = params.amp;
  var rOuter, rInner;

  if (params.ripdir === "vertical") {
    rOuter = br * (1 + amp * Math.sin(params.waves * ang + phase));
  } else {
    rOuter = br * (1 + amp * Math.sin((params.waves * 2 * Math.PI) * v + 1.5 * ang));
  }
  rInner = Math.max(1, rOuter - params.wallFixed); // vase wall ~0.7mm
  return rInner;
}

// Seam-safe tube (no duplicate seam column); height along Z from 0..H
function buildSurface() {
  var radialSeg = (params.res === "low") ? 96 : ((params.res === "med") ? 180 : 300);
  var heightSeg = (params.res === "low") ? 120 : ((params.res === "med") ? 220 : 360);

  var H = params.height;
  var R0 = params.rbase;
  var R1 = R0 * params.topscale;
  var waves = params.waves;
  var amp = params.amp;
  var twist = THREE.MathUtils.degToRad(params.twist);
  var EPS = 1e-4;

  var verts = new Float32Array((radialSeg) * (heightSeg + 1) * 3);
  var p = 0;
  for (var j = 0; j <= heightSeg; j++) {
    var v = j / heightSeg;
    var z = H * v; // 0..H
    var phase = twist * v;
    for (var i = 0; i < radialSeg; i++) {
      var u = i / radialSeg;
      var ang = u * Math.PI * 2 + EPS;
      var br = baseRadius(v, R0, R1);
      var r = (params.ripdir === "vertical")
        ? br * (1 + amp * Math.sin(waves * ang + phase))
        : br * (1 + amp * Math.sin((waves * 2 * Math.PI) * v + 1.5 * ang));
      verts[p++] = r * Math.cos(ang);
      verts[p++] = r * Math.sin(ang);
      verts[p++] = z;
    }
  }
  var geo = new THREE.BufferGeometry();
  geo.setAttribute("position", new THREE.BufferAttribute(verts, 3));

  var idx = new Uint32Array(radialSeg * heightSeg * 6);
  var k = 0;
  for (var jj = 0; jj < heightSeg; jj++) {
    for (var ii = 0; ii < radialSeg; ii++) {
      var i2 = (ii + 1) % radialSeg;
      var a = jj * radialSeg + ii;
      var b = jj * radialSeg + i2;
      var c = (jj + 1) * radialSeg + ii;
      var d = (jj + 1) * radialSeg + i2;
      idx[k++] = a; idx[k++] = c; idx[k++] = b;
      idx[k++] = b; idx[k++] = c; idx[k++] = d;
    }
  }
  geo.setIndex(new THREE.BufferAttribute(idx, 1));
  var smooth = geo.toNonIndexed();
  smooth.computeVertexNormals();
  return smooth;
}

// Conforming cap: extruded shape that matches the inner ripple at v=0 (bottom) or v=1 (top)
function buildCapAt(vFrac, holeRadius, capH) {
  var radialSeg = (params.res === "low") ? 96 : ((params.res === "med") ? 180 : 300);
  var EPS = 1e-4;

  // Outer boundary: inner wall profile at this height
  var shape = new THREE.Shape();
  for (var i = 0; i <= radialSeg; i++) {
    var u = (i % radialSeg) / radialSeg;
    var ang = u * Math.PI * 2 + EPS;
    var r = innerRadiusAt(vFrac, ang) * 0.995; // tiny shrink to avoid z-fighting
    var x = r * Math.cos(ang);
    var y = r * Math.sin(ang);
    if (i === 0) shape.moveTo(x, y); else shape.lineTo(x, y);
  }
  shape.closePath();

  // Inner hole for E27 fitting
  var hole = new THREE.Path();
  var holeSeg = 96;
  for (var j = 0; j <= holeSeg; j++) {
    var a2 = (j / holeSeg) * Math.PI * 2;
    var xh = holeRadius * Math.cos(a2);
    var yh = holeRadius * Math.sin(a2);
    if (j === 0) hole.moveTo(xh, yh); else hole.lineTo(xh, yh);
  }
  hole.closePath();
  shape.holes.push(hole);

  var extrude = new THREE.ExtrudeGeometry(shape, { depth: capH, bevelEnabled: false, curveSegments: radialSeg });
  // Position along Z: bottom from 0..capH, top from (H - capH)..H
  var zOffset = (vFrac === 1) ? (params.height - capH) : 0;
  extrude.translate(0, 0, zOffset);
  return extrude;
}

function rebuild() {
  // Clamp to Bambu X1C volume (256³) with margin
  var safety = 6;
  var maxHalf = 128 - safety;
  var bellyMax = 1 + 0.18;
  var scaleMax = Math.max(1, params.topscale);
  var radialLimit = maxHalf / ((1 + Math.max(0, params.amp)) * bellyMax * scaleMax);
  if (params.rbase > radialLimit) params.rbase = radialLimit;
  if (params.height > 256 - safety) params.height = 256 - safety;

  function setL(id, val) { var el = document.getElementById("val_" + id); if (el) el.textContent = String(val); }
  setL("height", Math.round(params.height));
  setL("rbase", Math.round(params.rbase));
  setL("topscale", Number(params.topscale).toFixed(2));
  setL("waves", params.waves);
  setL("amp", Number(params.amp).toFixed(2));
  setL("twist", params.twist);
  setL("top", params.topHole);
  setL("bottom", params.bottomHole);

  if (group) { scene.remove(group); group.traverse(function(o){ if (o.geometry) o.geometry.dispose(); }); }
  group = new THREE.Group();

  makeMaterial();

  // Lamp body (Z-up 0..H)
  var outerGeo = buildSurface();
  var outerMesh = new THREE.Mesh(outerGeo, materialOuter);
  group.add(outerMesh);

  // Conforming cap(s)
  var capH = 5; // mm
  if (params.mount === "standing") {
    var capBottom = new THREE.Mesh(buildCapAt(0, params.bottomHole/2, capH), materialOuter);
    group.add(capBottom);
  } else {
    // Hanging cable
    var cableMat = new THREE.MeshPhysicalMaterial({ color: 0x111111, roughness: 0.9, metalness: 0.0 });
    var cableLen = 300;
    var cable = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, cableLen, 24), cableMat);
    cable.position.z = params.height + cableLen/2;
    group.add(cable);

    var capTop = new THREE.Mesh(buildCapAt(1, params.topHole/2, capH), materialOuter);
    group.add(capTop);
  }

  // Ensure group sits on z=0 (no rotation tricks)
  group.position.z = 0;

  // Focus camera target to the lamp's mid-height
  controls.target.set(0, 0, params.height * 0.5);
  controls.update();

  scene.add(group);
}

function bindRange(id, key, fmt) {
  var el = document.getElementById(id);
  var lab = document.getElementById("val_" + id);
  function update() {
    params[key] = parseFloat(el.value);
    if (lab) lab.textContent = fmt ? fmt(el.value) : el.value;
    rebuild();
  }
  el.addEventListener("input", update);
  update();
}

bindRange("height", "height");
bindRange("rbase", "rbase");
bindRange("topscale", "topscale", function(v){ return Number(v).toFixed(2); });
bindRange("waves", "waves");
bindRange("amp", "amp", function(v){ return Number(v).toFixed(2); });
bindRange("twist", "twist");
bindRange("topHole", "topHole");
bindRange("bottomHole", "bottomHole");

document.getElementById("ripdir").addEventListener("change", function(e){ params.ripdir = e.target.value; rebuild(); });
document.getElementById("finish").addEventListener("change", function(e){ params.finish = e.target.value; rebuild(); });
document.getElementById("res").addEventListener("change", function(e){ params.res = e.target.value; rebuild(); });
document.getElementById("mount").addEventListener("change", function(e){ params.mount = e.target.value; rebuild(); });

window.addEventListener("resize", function(){
  renderer.setSize(window.innerWidth - 360, window.innerHeight);
  camera.aspect = (window.innerWidth - 360) / window.innerHeight;
  camera.updateProjectionMatrix();
});

function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
setVersion();
rebuild();
animate();
</script>
</body>
</html>
