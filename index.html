<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organic Lamp Designer</title>

  <style>
    :root{
      /* Light panel, dark stage */
      --stage-bg: #0e1116;          /* keep dark for lamp visibility */
      --panel-bg: #f6f8fb;          /* light controls panel */
      --panel-border: #d9e0ea;
      --text: #1c2636;
      --muted: #5b6b82;
      --chip: #eef3ff;
      --chip-text:#2754b5;
      --slider-track:#d7dfeb;
      --slider-thumb:#2b6ef3;
    }

    *{box-sizing:border-box}
    html, body { height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; color:var(--text); background:var(--stage-bg); }
    #app { display:grid; grid-template-columns:360px 1fr; height:100%; }

    /* Desktop sidebar (default) */
    aside#sidebar {
      background:var(--panel-bg);
      border-right:1px solid var(--panel-border);
      overflow:auto; padding:16px;
    }
    h1 { font-size:18px; margin:0 0 10px; color:var(--text); display:flex; align-items:baseline; gap:8px; }
    #version { font-size:12px; color:var(--muted); background:var(--chip); border-radius:999px; padding:2px 8px; }
    .row { margin:12px 0 18px; }
    label { display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-bottom:6px; }
    select, input[type=range] { width:100%; }
    select {
      background:white; border:1px solid var(--panel-border); border-radius:10px; padding:10px 12px; color:var(--text);
      outline:none;
    }
    input[type=range]{ -webkit-appearance:none; height:32px; background:transparent; padding:6px 0; }
    input[type=range]::-webkit-slider-runnable-track{ height:6px; background:var(--slider-track); border-radius:999px; }
    input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:22px; height:22px; border-radius:50%; background:var(--slider-thumb); margin-top:-8px; box-shadow:0 1px 3px rgba(0,0,0,.2); }
    input[type=range]::-moz-range-track{ height:6px; background:var(--slider-track); border-radius:999px; }
    input[type=range]::-moz-range-thumb{ width:22px; height:22px; border:none; border-radius:50%; background:var(--slider-thumb); }

    .note { font-size:11px; color:var(--muted); margin-top:10px; }

    /* Stage */
    #canvas { display:block; width:100%; height:100%; background:var(--stage-bg); }

    /* ---------- Mobile: bottom sheet instead of sidebar ---------- */
    @media (max-width: 900px){
      #app{ 
        grid-template-columns: 1fr; 
        grid-template-rows: 1fr auto; /* canvas then panel */
      }
      aside#sidebar{
        grid-column: 1 / 2;
        grid-row: 2 / 3;
        width: 100%;
        max-height: 45vh;              /* roughly bottom third */
        height: min(45vh, 420px);
        border-right: none;
        border-top: 1px solid var(--panel-border);
        padding-bottom: 12px;
        overflow:auto;
      }
      /* Collapsed bottom sheet (peek) */
      aside#sidebar.collapsed{
        height: 56px;
        max-height: 56px;
        overflow: hidden;
      }
      /* Bottom sheet handle */
      .sheet-handle{
        display:flex; align-items:center; justify-content:space-between; gap:8px;
        position: sticky; top: 0; background: var(--panel-bg); padding:8px 4px 6px 4px;
      }
      .dragbar{
        width: 48px; height: 5px; border-radius: 999px; background:#cdd7e7; margin: 0 auto 6px auto;
      }
      .toggle{
        border:1px solid var(--panel-border); background:white; color:var(--text);
        border-radius:10px; padding:6px 10px; font-size:13px;
      }
      /* Hide desktop title row on mobile; we replace with handle */
      .desktop-header { display:none; }
    }

    /* Desktop: show title row; mobile uses bottom sheet header */
    .desktop-header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px; }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "@app/": "./src/"
    }
  }
  </script>

  <script> window.APP_VERSION = "0.9.1"; </script>
</head>
<body>
<div id="app">
  <aside id="sidebar" class="collapsed"><!-- start collapsed on mobile -->
    <!-- Desktop header -->
    <div class="desktop-header">
      <h1>Organic Lamp Designer <span id="version"></span></h1>
    </div>

    <!-- Mobile bottom-sheet handle -->
    <div class="sheet-handle">
      <div class="dragbar"></div>
      <button id="togglePanel" class="toggle">Controls</button>
    </div>

    <div class="row"><label><span>Height (mm)</span><span id="val_height"></span></label><input id="height" type="range" min="120" max="250" value="230"></div>
    <div class="row"><label><span>Base Radius (mm)</span><span id="val_rbase"></span></label><input id="rbase" type="range" min="40" max="64" value="64"></div>
    <div class="row"><label><span>Top Scale (0.4–1.2)</span><span id="val_topscale"></span></label><input id="topscale" type="range" min="0.4" max="1.2" step="0.01" value="0.70"></div>
    <div class="row"><label><span>Waves</span><span id="val_waves"></span></label><input id="waves" type="range" min="6" max="40" value="18"></div>
    <div class="row"><label><span>Amplitude</span><span id="val_amp"></span></label><input id="amp" type="range" min="0" max="0.35" step="0.01" value="0.22"></div>
    <div class="row"><label><span>Twist (°)</span><span id="val_twist"></span></label><input id="twist" type="range" min="0" max="900" step="10" value="420"></div>

    <div class="row"><label><span>Ripple Direction</span></label>
      <select id="ripdir">
        <option value="vertical" selected>Vertical folds (around)</option>
        <option value="horizontal">Horizontal rings (stacked)</option>
      </select>
    </div>

    <div class="row"><label><span>Mounting</span></label>
      <select id="mount">
        <option value="hanging" selected>Hanging (top cap + cable + E27)</option>
      </select>
    </div>

    <div class="row"><label><span>Finish</span></label>
      <select id="finish">
        <option value="opaque_white" selected>Opaque white (gloss)</option>
        <option value="translucent_white">Translucent white (gloss)</option>
        <option value="bronze">Bronze (polished)</option>
        <option value="silver">Silver (polished)</option>
        <option value="gold">Gold (polished)</option>
      </select>
    </div>

    <div class="row"><label><span>Preview Quality</span></label>
      <select id="res">
        <option value="low">Low (fast)</option>
        <option value="med" selected>Medium</option>
        <option value="high">High</option>
      </select>
    </div>

    <div class="note">Hanging lamp preview. Vase-mode preview; internal ~0.7 mm wall for manufacturing. E27 hole fixed.</div>
  </aside>

  <canvas id="canvas"></canvas>
</div>

<script type="module">
  import "@app/main.js";
  import { forceResize } from "@app/main.js";

  // Mobile bottom-sheet toggle
  const aside = document.getElementById('sidebar');
  const btn   = document.getElementById('togglePanel');

  function isMobile(){ return window.matchMedia('(max-width: 900px)').matches; }
  function openPanel(){ aside.classList.remove('collapsed'); forceResize(); }
  function closePanel(){ aside.classList.add('collapsed'); forceResize(); }
  function togglePanel(){
    if (!isMobile()) return; // desktop: ignore
    aside.classList.toggle('collapsed');
    // wait for CSS transition? not needed; we compute sizes instantly
    forceResize();
  }
  btn.addEventListener('click', togglePanel);

  // Start expanded on desktop
  function syncInitialState(){
    if (!isMobile()){ aside.classList.remove('collapsed'); }
    else { aside.classList.add('collapsed'); } // collapsed peek on mobile
    forceResize();
  }
  window.addEventListener('resize', syncInitialState, { passive:true });
  syncInitialState();
</script>
</body>
</html>
